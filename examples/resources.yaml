AWSTemplateFormatVersion: 2010-09-09

Description: AWS resources needed to develop, run, and test the CloudFormation controller for Flux

Resources:

  # Bucket that the controller will use to upload CFN template files prior to syncing them to their CFN stack
  TemplateBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub flux-cfn-templates-${AWS::AccountId}-${AWS::Region}
      LifecycleConfiguration:
        Rules:
          - ExpirationInDays : 1
            NoncurrentVersionExpiration:
              NewerNoncurrentVersions: 5
              NoncurrentDays: 1
            AbortIncompleteMultipartUpload:
              DaysAfterInitiation: 1
            Status: Enabled
      VersioningConfiguration:
        Status: Enabled
    DeletionPolicy: Delete

  # Enforce HTTPS only on the template bucket
  TemplateBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref TemplateBucket
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Action: 's3:*'
            Effect: Deny
            Principal: '*'
            Resource:
              - !Sub arn:aws:s3:::${TemplateBucket}/*
              - !Sub arn:aws:s3:::${TemplateBucket}
            Condition:
              Bool:
                'aws:SecureTransport': false

  # Repository for storing CloudFormation templates
  TemplateRepo:
    Type: AWS::CodeCommit::Repository
    Properties:
      RepositoryName: my-cloudformation-templates

  # Repository for storing Flux configuration
  FluxRepo:
    Type: AWS::CodeCommit::Repository
    Properties:
      RepositoryName: my-flux-configuration

  # User for Flux to use when interacting with CodeCommit repos
  GitUser:
    Type: AWS::IAM::User
    Properties:
      UserName: 'flux-git'
      ManagedPolicyArns:
        - "arn:aws:iam::aws:policy/AWSCodeCommitPowerUser"

  GitCredentials:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: flux-git-credentials
      # CloudFormation does not yet support creating service-specific credentials,
      # so this secret is a placeholder until the credentials are created manually.
      SecretString: |
        {
          "ServiceUserName":"TO-FILL-IN",
          "ServicePassword":"TO-FILL-IN"
        }

  # ECR repo for storing development images of the CFN controller
  MyRepository:
    Type: AWS::ECR::Repository
    Properties:
      RepositoryName: aws-cloudformation-controller-for-flux
